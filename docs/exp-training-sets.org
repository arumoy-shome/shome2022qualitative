#+title: Experiment with Training Sets
#+date: [2022-11-03 Thu]
#+options: toc:t
#+toc: tables
#+html_head: <link rel="stylesheet" href="main.css">
#+property: header-args:python :session *sh22qual* :exports both :eval no-export

This document analyses the =data/exp-training-sets-*-50.csv= datasets.

* Init

#+begin_src python :results silent
  import os
  import sys
  import pandas as pd
  import seaborn as sns
  import matplotlib.pyplot as plt

  ROOTDIR = os.path.abspath(os.path.join(os.getcwd(), ".."))
  DATADIR = os.path.join(ROOTDIR, "data")
  sys.path.insert(0, ROOTDIR)
  pd.set_option('display.max_columns', None)
  pd.set_option('display.max_colwidth', None)
#+end_src

* EDA
Lets analyse the data obtained from 50 iterations of the experiment.

#+begin_src python
  data = pd.read_csv(os.path.join(DATADIR, "exp-training-sets-adult-sex-50.csv"))

  data
#+end_src

#+RESULTS:
#+begin_example
      privileged protected     FP       FPR dataset_label  num_positives  \
0           None       sex    NaN       NaN         adult         2820.0   
1           None       sex    NaN       NaN         adult          832.0   
2           True       sex    NaN       NaN         adult         2439.0   
3           True       sex    NaN       NaN         adult          702.0   
4          False       sex    NaN       NaN         adult          381.0   
...          ...       ...    ...       ...           ...            ...   
17095       True       sex  442.0  0.084464         adult            NaN   
17096      False       sex   61.0  0.018752         adult            NaN   
17097       None       sex  752.0  0.088617         adult            NaN   
17098       True       sex  654.0  0.124976         adult            NaN   
17099      False       sex  110.0  0.033815         adult            NaN   

       base_rate                   model      TP  iteration       TNR  \
0       0.249425                    None     NaN          0       NaN   
1       0.245355                    None     NaN          0       NaN   
2       0.317909                    None     NaN          0       NaN   
3       0.310071                    None     NaN          0       NaN   
4       0.104843                    None     NaN          0       NaN   
...          ...                     ...     ...        ...       ...   
17095        NaN      adaboostclassifier  1521.0         49  0.915536   
17096        NaN      adaboostclassifier   191.0         49  0.981248   
17097        NaN  randomforestclassifier  1754.0         49  0.911383   
17098        NaN  randomforestclassifier  1547.0         49  0.875024   
17099        NaN  randomforestclassifier   215.0         49  0.966185   

             f1  theil_index subset_label      FN  accuracy       TPR  \
0           NaN          NaN         test     NaN       NaN       NaN   
1           NaN          NaN        train     NaN       NaN       NaN   
2           NaN          NaN         test     NaN       NaN       NaN   
3           NaN          NaN        train     NaN       NaN       NaN   
4           NaN          NaN         test     NaN       NaN       NaN   
...         ...          ...          ...     ...       ...       ...   
17095  0.691050          NaN         test   918.0  0.822732  0.623616   
17096  0.603476          NaN         test   190.0  0.930930  0.501312   
17097  0.658656     0.123007         test  1066.0  0.839200  0.621986   
17098  0.666810          NaN         test   892.0  0.798488  0.634276   
17099  0.609065          NaN         test   166.0  0.924051  0.564304   

            PPV  average_abs_odds_difference  frac       FNR      TN  \
0           NaN                          NaN   0.1       NaN     NaN   
1           NaN                          NaN   0.1       NaN     NaN   
2           NaN                          NaN   0.1       NaN     NaN   
3           NaN                          NaN   0.1       NaN     NaN   
4           NaN                          NaN   0.1       NaN     NaN   
...         ...                          ...   ...       ...     ...   
17095  0.774834                          NaN   1.0  0.376384  4791.0   
17096  0.757937                          NaN   1.0  0.498688  3192.0   
17097  0.699920                     0.075515   1.0  0.378014  7734.0   
17098  0.702862                          NaN   1.0  0.365724  4579.0   
17099  0.661538                          NaN   1.0  0.435696  3143.0   

       statistical_parity_difference  true_positive_rate_difference  \
0                          -0.213066                            NaN   
1                          -0.194720                            NaN   
2                                NaN                            NaN   
3                                NaN                            NaN   
4                                NaN                            NaN   
...                              ...                            ...   
17095                            NaN                            NaN   
17096                            NaN                            NaN   
17097                      -0.193225                      -0.063657   
17098                            NaN                            NaN   
17099                            NaN                            NaN   

       disparate_impact  num_negatives  
0              0.329790         8486.0  
1              0.372014         2559.0  
2                   NaN         5233.0  
3                   NaN         1562.0  
4                   NaN         3253.0  
...                 ...            ...  
17095               NaN            NaN  
17096               NaN            NaN  
17097          0.319052            NaN  
17098               NaN            NaN  
17099               NaN            NaN  

[17100 rows x 26 columns]
#+end_example

#+begin_src python
  data.dtypes
#+end_src

#+RESULTS:
#+begin_example
privileged                        object
protected                         object
FP                               float64
FPR                              float64
dataset_label                     object
num_positives                    float64
base_rate                        float64
model                             object
TP                               float64
iteration                          int64
TNR                              float64
f1                               float64
theil_index                      float64
subset_label                      object
FN                               float64
accuracy                         float64
TPR                              float64
PPV                              float64
average_abs_odds_difference      float64
frac                             float64
FNR                              float64
TN                               float64
statistical_parity_difference    float64
true_positive_rate_difference    float64
disparate_impact                 float64
num_negatives                    float64
dtype: object
#+end_example

#+begin_src python
  data["frac"].describe()
#+end_src

#+RESULTS:
: count    17100.000000
: mean         0.550000
: std          0.273869
: min          0.100000
: 25%          0.300000
: 50%          0.550000
: 75%          0.800000
: max          1.000000
: Name: frac, dtype: float64

#+begin_src python
  data["frac"].value_counts()
#+end_src

#+RESULTS:
#+begin_example
0.10    900
0.60    900
0.95    900
0.90    900
0.85    900
0.80    900
0.75    900
0.70    900
0.65    900
0.55    900
0.15    900
0.50    900
0.45    900
0.40    900
0.35    900
0.30    900
0.25    900
0.20    900
1.00    900
Name: frac, dtype: int64
#+end_example

* Disparate Impact & Statistical Parity Difference
In this section we take a closer look at the disparate impact &
statistical parity difference metrics.

#+begin_src python
  data = data[data["privileged"] == "None"]

  from src.data import process
  process(data)

  data
#+end_src

#+RESULTS:
#+begin_example
      privileged protected      FP       FPR dataset_label  num_positives  \
0           None       sex     NaN       NaN         adult         2820.0   
1           None       sex     NaN       NaN         adult          832.0   
6           None       sex   647.0  0.076243         adult            NaN   
9           None       sex  1075.0  0.126679         adult            NaN   
12          None       sex   621.0  0.073179         adult            NaN   
...          ...       ...     ...       ...           ...            ...   
17083       None       sex     NaN       NaN         adult         8388.0   
17088       None       sex   593.0  0.069880         adult            NaN   
17091       None       sex   996.0  0.117370         adult            NaN   
17094       None       sex   503.0  0.059274         adult            NaN   
17097       None       sex   752.0  0.088617         adult            NaN   

       base_rate                   model      TP  iteration       TNR  \
0       0.249425                    None     NaN          0       NaN   
1       0.245355                    None     NaN          0       NaN   
6            NaN      logisticregression  1665.0          0  0.923757   
9            NaN  decisiontreeclassifier  1694.0          0  0.873321   
12           NaN      adaboostclassifier  1770.0          0  0.926821   
...          ...                     ...     ...        ...       ...   
17083   0.247317                    None     NaN         49       NaN   
17088        NaN      logisticregression  1665.0         49  0.930120   
17091        NaN  decisiontreeclassifier  1730.0         49  0.882630   
17094        NaN      adaboostclassifier  1712.0         49  0.940726   
17097        NaN  randomforestclassifier  1754.0         49  0.911383   

             f1  theil_index subset_label      FN  accuracy       TPR  \
0           NaN          NaN         test     NaN       NaN       NaN   
1           NaN          NaN        train     NaN       NaN       NaN   
6      0.648870     0.129037         test  1155.0  0.840616  0.590426   
9      0.606191     0.136930         test  1126.0  0.805325  0.600709   
12     0.679332     0.117831         test  1050.0  0.852202  0.627660   
...         ...          ...          ...     ...       ...       ...   
17083       NaN          NaN        train     NaN       NaN       NaN   
17088  0.655770     0.127501         test  1155.0  0.845392  0.590426   
17091  0.623873     0.131498         test  1090.0  0.815496  0.613475   
17094  0.680040     0.120159         test  1108.0  0.857509  0.607092   
17097  0.658656     0.123007         test  1066.0  0.839200  0.621986   

            PPV  average_abs_odds_difference  frac       FNR      TN  \
0           NaN                          NaN   0.1       NaN     NaN   
1           NaN                          NaN   0.1       NaN     NaN   
6      0.720156                     0.072402   0.1  0.409574  7839.0   
9      0.611773                     0.088064   0.1  0.399291  7411.0   
12     0.740276                     0.104579   0.1  0.372340  7865.0   
...         ...                          ...   ...       ...     ...   
17083       NaN                          NaN   1.0       NaN     NaN   
17088  0.737378                     0.080357   1.0  0.409574  7893.0   
17091  0.634629                     0.062166   1.0  0.386525  7490.0   
17094  0.772912                     0.094008   1.0  0.392908  7983.0   
17097  0.699920                     0.075515   1.0  0.378014  7734.0   

       statistical_parity_difference  true_positive_rate_difference  \
0                           0.213066                            NaN   
1                           0.194720                            NaN   
6                           0.186187                       0.060548   
9                           0.197092                       0.069404   
12                          0.201351                       0.127876   
...                              ...                            ...   
17083                       0.194209                            NaN   
17088                       0.186042                       0.081791   
17091                       0.178510                       0.041678   
17094                       0.186520                       0.122304   
17097                       0.193225                       0.063657   

       disparate_impact  num_negatives  
0              0.566831         8486.0  
1              0.309467         2559.0  
6              0.774933            NaN  
9              0.378791            NaN  
12             0.925193            NaN  
...                 ...            ...  
17083          0.292248        25528.0  
17088          0.851317            NaN  
17091          0.126984            NaN  
17094          0.925032            NaN  
17097          0.632279            NaN  

[5700 rows x 26 columns]
#+end_example

#+begin_src python :results file
  name = "lineplot--exp-training-sets--adult-sex--di-spd--train-test.svg"
  cols = ["disparate_impact", "statistical_parity_difference"]

  fig, axs = plt.subplots(
      nrows=2,
      ncols=2,
      figsize=(10,10),
      sharey=True,
  )

  # top row: data(test) vs model
  for idx, metric in enumerate(cols):
      ax = axs[0,idx]
      ax.set_ylabel(metric)
      sns.lineplot(
          data=data[data["subset_label"] == "test"],
          x="frac",
          y=metric,
          hue="model",
          style="model",
          ax=ax,
      )

  # bottom row: data(train) vs model
  _ = data
  _.loc[(_["model"] != "None"), "subset_label"] = "train"
  for idx, metric in enumerate(cols):
      ax = axs[1, idx]
      ax.set_ylabel(metric)
      sns.lineplot(
          data=_,
          x="frac",
          y=metric,
          hue="model",
          style="model",
          ax=ax
      )

  fig.savefig(name, format="svg")
  name
#+end_src

#+RESULTS:
[[file:lineplot--exp-training-sets--adult-sex--di-spd--train-test.svg]]

