<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-10-21 Fri 11:28 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Experiment with Feature Sets</title>
<meta name="author" content="Arumoy Shome" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" href="main.css">
</head>
<body>
<div id="content" class="content">
<h1 class="title">Experiment with Feature Sets</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org8a5b57b">1. Init</a></li>
<li><a href="#org3cac9ec">2. EDA</a></li>
<li><a href="#org1111c83">3. Disparate Impact &amp; Statistical Parity Difference <code>[0/2]</code></a>
<ul>
<li><a href="#org4801180">3.1. Relationship between data &amp; model variant <code>[0/0]</code></a></li>
</ul>
</li>
<li><a href="#org04bfc4f">4. Base rate &amp; others <code>[0/2]</code></a></li>
</ul>
</div>
</div>
<p>
This document analyses the <code>data/exp-feature-sets-*-50.csv</code> datasets
ie. results from the feature sets experiments.
</p>

<div id="outline-container-org8a5b57b" class="outline-2">
<h2 id="org8a5b57b"><span class="section-number-2">1.</span> Init</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-python">import os
import sys
import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt

ROOTDIR = os.path.abspath(os.path.join(os.getcwd(), ".."))
DATADIR = os.path.join(ROOTDIR, "data")
sys.path.insert(0, ROOTDIR)
pd.set_option('display.max_columns', None)
pd.set_option('display.max_colwidth', None)
</pre>
</div>
</div>
</div>

<div id="outline-container-org3cac9ec" class="outline-2">
<h2 id="org3cac9ec"><span class="section-number-2">2.</span> EDA</h2>
<div class="outline-text-2" id="text-2">
<p>
Lets analyse the data obtained from 50 iterations of the experiment.
First, we need to combine the datasets into a single dataframe.
</p>

<div class="org-src-container">
<pre class="src src-python">import glob

frames = [pd.read_csv(frame) for frame in glob.glob(os.path.join(DATADIR, "*-50.csv"))]

data = pd.concat(frames)
data.shape
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">93750</td>
<td class="org-right">25</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-python">data.dtypes
</pre>
</div>

<pre class="example" id="org14dcff9">
num_negatives                    float64
theil_index                      float64
accuracy                         float64
FPR                              float64
average_abs_odds_difference      float64
disparate_impact                 float64
model                             object
FN                               float64
TNR                              float64
protected                         object
FP                               float64
base_rate                        float64
TPR                              float64
num_positives                    float64
true_positive_rate_difference    float64
FNR                              float64
TP                               float64
statistical_parity_difference    float64
PPV                              float64
f1                               float64
num_features                       int64
privileged                        object
iteration                          int64
TN                               float64
dataset_label                     object
dtype: object
</pre>
</div>
</div>

<div id="outline-container-org1111c83" class="outline-2">
<h2 id="org1111c83"><span class="section-number-2">3.</span> Disparate Impact &amp; Statistical Parity Difference <code>[0/2]</code></h2>
<div class="outline-text-2" id="text-3">
<p>
In this section we take a closer look at the disparate impact &amp;
statistical parity difference metrics. We start with these two since
we have both data &amp; model variants for these metrics.
</p>

<div class="org-src-container">
<pre class="src src-python"># fairness metrics are calculated without conditioning on any (un)privileged group
metrics = data[data["privileged"] == "None"]
metrics = metrics[[
    "disparate_impact",
    "statistical_parity_difference",
    "iteration",
    "model",
    "protected",
    "num_features",
    "dataset_label"
]]

metrics
</pre>
</div>

<pre class="example" id="orgdc87a9c">
       disparate_impact  statistical_parity_difference  iteration  \
0              0.380463                      -0.190953          0   
3              0.325643                      -0.176814          0   
6              0.425396                      -0.167885          0   
9              0.322013                      -0.170099          0   
12             0.360431                      -0.176439          0   
...                 ...                            ...        ...   
29985          0.456837                      -0.138794         49   
29988          0.272496                      -0.112363         49   
29991          0.528534                      -0.108183         49   
29994          0.263804                      -0.117350         49   
29997          0.384522                      -0.081692         49   

                        model protected  num_features dataset_label  
0                        None       sex            11         adult  
3          logisticregression       sex            11         adult  
6      decisiontreeclassifier       sex            11         adult  
9          adaboostclassifier       sex            11         adult  
12     randomforestclassifier       sex            11         adult  
...                       ...       ...           ...           ...  
29985                    None      RACE             3          meps  
29988      logisticregression      RACE             3          meps  
29991  decisiontreeclassifier      RACE             3          meps  
29994      adaboostclassifier      RACE             3          meps  
29997  randomforestclassifier      RACE             3          meps  

[31250 rows x 7 columns]
</pre>

<p>
Lets preprocess the data next prior to analysis. zhang2021ignorance
took the absolute value for all fairness metrics. For disparate impact
zhang took the distance of the metric to one &amp; then normalised the
value between [0, 1]. We also lowercase the values in the <code>protected</code>
column while we are are at it.
</p>

<div class="org-src-container">
<pre class="src src-python">cols = ["disparate_impact", "statistical_parity_difference"]
metrics["protected"] = metrics["protected"].str.lower()
metrics["disparate_impact"] = metrics["disparate_impact"] - 1
metrics[cols] = metrics[cols].abs()

from sklearn.preprocessing import MinMaxScaler

scaler = MinMaxScaler()
metrics["disparate_impact"] = scaler.fit_transform(
    metrics["disparate_impact"].values.reshape(-1, 1)
).ravel()

</pre>
</div>

<p>
Lets create a simple lineplot to observe the general trend of the
fairness metrics across various feature sets. Since different datasets
have different protected attributes, we need to create separate
figures for each dataset.
</p>


<div id="orgaf41809" class="figure">
<p><img src="lineplot--exp-feature-sets--adult--di-spd.svg" alt="lineplot--exp-feature-sets--adult--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 1: </span>Lineplot DI &amp; SPD Adult</p>
</div>


<div id="org05d0b5e" class="figure">
<p><img src="lineplot--exp-feature-sets--compas--di-spd.svg" alt="lineplot--exp-feature-sets--compas--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 2: </span>Lineplot DI &amp; SPD Compas</p>
</div>


<div id="org2697dfc" class="figure">
<p><img src="lineplot--exp-feature-sets--bank--di-spd.svg" alt="lineplot--exp-feature-sets--bank--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 3: </span>Lineplot DI &amp; SPD Bank</p>
</div>


<div id="org42b43b5" class="figure">
<p><img src="lineplot--exp-feature-sets--german--di-spd.svg" alt="lineplot--exp-feature-sets--german--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 4: </span>Lineplot DI &amp; SPD German</p>
</div>


<div id="org22aa9a3" class="figure">
<p><img src="lineplot--exp-feature-sets--meps--di-spd.svg" alt="lineplot--exp-feature-sets--meps--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 5: </span>Lineplot DI &amp; SPD Meps</p>
</div>

<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> focus on each dataset</li>
<li class="off"><code>[&#xa0;]</code> widen across all datasets</li>
<li>generally speaking, in some dataset-protected-model combinations I
see that increasing feature set size improves fairness</li>
</ul>

<p>
Lets also look at the distribution of the fairness metrics across
feature set sizes using boxplots.
</p>


<div id="orgf3af061" class="figure">
<p><img src="boxplot--exp-feature-sets--adult--di-spd.svg" alt="boxplot--exp-feature-sets--adult--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 6: </span>Boxplot DI &amp; SPD Adult</p>
</div>


<div id="orge628458" class="figure">
<p><img src="boxplot--exp-feature-sets--compas--di-spd.svg" alt="boxplot--exp-feature-sets--compas--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 7: </span>Boxplot DI &amp; SPD Compas</p>
</div>


<div id="orgd3efda9" class="figure">
<p><img src="boxplot--exp-feature-sets--bank--di-spd.svg" alt="boxplot--exp-feature-sets--bank--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 8: </span>Boxplot DI &amp; SPD Bank</p>
</div>


<div id="orgcecc038" class="figure">
<p><img src="boxplot--exp-feature-sets--german--di-spd.svg" alt="boxplot--exp-feature-sets--german--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 9: </span>Boxplot DI &amp; SPD German</p>
</div>


<div id="orgeeb617a" class="figure">
<p><img src="boxplot--exp-feature-sets--meps--di-spd.svg" alt="boxplot--exp-feature-sets--meps--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 10: </span>Boxplot DI &amp; SPD Meps</p>
</div>
</div>

<div id="outline-container-org4801180" class="outline-3">
<h3 id="org4801180"><span class="section-number-3">3.1.</span> Relationship between data &amp; model variant <code>[0/0]</code></h3>
<div class="outline-text-3" id="text-3-1">
<p>
In this section we want to validate that the data &amp; model metrics are
related to one another. We employ two types of tests:
</p>
<ol class="org-ol">
<li>Correlation between data &amp; model variants</li>
<li>Fitting a linear regression model between data &amp; model variants</li>
</ol>

<p>
The data needs some manipulation to make it fit for further
visualisations. We want the following columns:
</p>
<ol class="org-ol">
<li>x: the data variant of fairness metrics (float)</li>
<li>y: the model variant of fairness metrics (float)</li>
<li>model: the model used for the y value</li>
<li>protected: the name of the protected attribute</li>
<li>metric: name of the fairness metric</li>
</ol>

<p>
As above, we will create different figures for each dataset.
</p>


<div id="orgedaa996" class="figure">
<p><img src="heatmap--exp-feature-sets--adult--di-spd.svg" alt="heatmap--exp-feature-sets--adult--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 11: </span>Heatmap DI &amp; SPD Adult</p>
</div>


<div id="orga365feb" class="figure">
<p><img src="heatmap--exp-feature-sets--compas--di-spd.svg" alt="heatmap--exp-feature-sets--compas--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 12: </span>Heatmap DI &amp; SPD Compas</p>
</div>


<div id="orgad1b7d6" class="figure">
<p><img src="heatmap--exp-feature-sets--bank--di-spd.svg" alt="heatmap--exp-feature-sets--bank--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 13: </span>Heatmap DI &amp; SPD Bank</p>
</div>


<div id="orga2e6ebe" class="figure">
<p><img src="heatmap--exp-feature-sets--german--di-spd.svg" alt="heatmap--exp-feature-sets--german--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 14: </span>Heatmap DI &amp; SPD German</p>
</div>


<div id="org5eb1dc4" class="figure">
<p><img src="heatmap--exp-feature-sets--meps--di-spd.svg" alt="heatmap--exp-feature-sets--meps--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 15: </span>Heatmap DI &amp; SPD Meps</p>
</div>

<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> analyse correlation heatmaps within datasets</li>
<li class="off"><code>[&#xa0;]</code> then generalise results across datasets</li>
<li>in general, I see that for certain dataset-protected-model
combinations, the data &amp; model variants are correlated.</li>
</ul>

<p>
Next, we want to fit a linear regression model on the data &amp; model
variants.
</p>


<div id="orgcc73cea" class="figure">
<p><img src="regplot--exp-feature-sets--adult--di-spd.svg" alt="regplot--exp-feature-sets--adult--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 16: </span>Regplot DI &amp; SPD Adult</p>
</div>


<div id="org4f7965a" class="figure">
<p><img src="regplot--exp-feature-sets--compas--di-spd.svg" alt="regplot--exp-feature-sets--compas--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 17: </span>Regplot DI &amp; SPD Compas</p>
</div>


<div id="org4a7e9c9" class="figure">
<p><img src="regplot--exp-feature-sets--bank--di-spd.svg" alt="regplot--exp-feature-sets--bank--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 18: </span>Regplot DI &amp; SPD Bank</p>
</div>


<div id="orga7a7506" class="figure">
<p><img src="regplot--exp-feature-sets--german--di-spd.svg" alt="regplot--exp-feature-sets--german--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 19: </span>Regplot DI &amp; SPD German</p>
</div>


<div id="org84d7a11" class="figure">
<p><img src="regplot--exp-feature-sets--meps--di-spd.svg" alt="regplot--exp-feature-sets--meps--di-spd.svg" class="org-svg" />
</p>
<p><span class="figure-number">Figure 20: </span>Regplot DI &amp; SPD Meps</p>
</div>
</div>
</div>
</div>


<div id="outline-container-org04bfc4f" class="outline-2">
<h2 id="org04bfc4f"><span class="section-number-2">4.</span> Base rate &amp; others <code>[0/2]</code></h2>
<div class="outline-text-2" id="text-4">
<p>
In this section we consider all 4 fairness metrics &amp; try to find a
relationship with the base rate metric since this is the only data
metric fairness that may be generalisable to all model fairness
metrics.
</p>

<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> lineplot of baserate vs. other metrics; how do the conditioned
base rates compare to other metrics?</li>
<li class="off"><code>[&#xa0;]</code> </li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-10-17 Mon 00:00</p>
<p class="author">Author: Arumoy Shome</p>
<p class="date">Created: 2022-10-21 Fri 11:28</p>
</div>
</body>
</html>
