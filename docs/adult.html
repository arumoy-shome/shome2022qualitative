<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-08-02 Tue 15:17 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Adult</title>
<meta name="author" content="Arumoy Shome" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Adult</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org7d04273">1. Init</a></li>
<li><a href="#org4e83383">2. Priliminary analysis</a></li>
<li><a href="#orgc2454db">3. Analysis of metrics</a>
<ul>
<li><a href="#orgf828e2c">3.1. Analysis of <code>num_{positive,negative}</code>, <code>num_{true,false}_{positive,negative}</code> &amp; <code>num_{true,false}_{positive_negative}_rate</code></a></li>
<li><a href="#orgd00b2fb">3.2. Analysis of <code>base_rate</code></a></li>
<li><a href="#org3e436e6">3.3. Analysis of <code>{positive,negative}_predictive_value</code> &amp; <code>false_{discovery,omission}_rate</code></a></li>
<li><a href="#orgc528df6">3.4. Analysis of <code>disparate_impact</code> &amp; <code>statistical_parity_difference</code></a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
In this file we analyse the results obtained from computing all
<code>BinaryLabelDatasetMetric</code> &amp; <code>ClassificationMetric</code> for the adult
dataset with a <code>LinearRegression</code> model, for a single protected
attribute <code>sex</code>. The results are stored in <code>adult.csv</code> which is what
we will analyse here. The dataset can be generated using the
<code>bin/adult.py</code> script.
</p>

<div id="outline-container-org7d04273" class="outline-2">
<h2 id="org7d04273"><span class="section-number-2">1.</span> Init</h2>
<div class="outline-text-2" id="text-1">
<p>
In this section we perform some sanity checks, load the necessary
modules &amp; the dataset.
</p>

<div class="org-src-container">
<pre class="src src-python">import pandas as pd
import numpy as np
pd.set_option('display.max_columns', None)
pd.set_option('display.max_colwidth', None)
pd.set_option('display.max_rows', None)

import matplotlib
matplotlib.use('Agg')           # non-interactive backend
import matplotlib.pyplot as plt
import seaborn as sns

import os
import sys
ROOTDIR = os.path.abspath(os.path.join(os.getcwd(), '..'))
DATADIR = os.path.join(ROOTDIR, 'data')

sys.path.insert(0, ROOTDIR)
from src import utils
from src.utils import data_metrics_columns, model_metrics_columns
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python">adult = pd.read_csv(os.path.join(DATADIR, 'adult.csv'))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4e83383" class="outline-2">
<h2 id="org4e83383"><span class="section-number-2">2.</span> Priliminary analysis</h2>
<div class="outline-text-2" id="text-2">
<p>
In this section we conduct some priliminary analysis of the dataset.
</p>

<div class="org-src-container">
<pre class="src src-python">adult
</pre>
</div>

<pre class="example" id="orgcbe7bf6">
         NPV       TNR dataset  num_negatives  statistical_parity_difference  \
0        NaN       NaN   adult        34014.0                      -0.198901   
1        NaN       NaN   adult        20988.0                            NaN   
2        NaN       NaN   adult        13026.0                            NaN   
3        NaN       NaN   adult        25514.0                      -0.201944   
4        NaN       NaN   adult        15720.0                            NaN   
5        NaN       NaN   adult         9794.0                            NaN   
6   0.878000  0.925412   adult            NaN                      -0.184484   
7        NaN       NaN   adult         8500.0                      -0.189774   
8   0.842962  0.894647   adult            NaN                            NaN   
9        NaN       NaN   adult         5268.0                            NaN   
10  0.936164  0.975557   adult            NaN                            NaN   
11       NaN       NaN   adult         3232.0                            NaN   

    disparate_impact       FDR       FPR  base_rate protected  num_positives  \
0           0.363470       NaN       NaN   0.247844       sex        11208.0   
1                NaN       NaN       NaN   0.312477       sex         9539.0   
2                NaN       NaN       NaN   0.113576       sex         1669.0   
3           0.355548       NaN       NaN   0.247730       sex         8402.0   
4                NaN       NaN       NaN   0.313357       sex         7174.0   
5                NaN       NaN       NaN   0.111414       sex         1228.0   
6           0.310398  0.270132  0.074588        NaN       sex            NaN   
7           0.387509       NaN       NaN   0.248187       sex         2806.0   
8                NaN  0.271792  0.105353        NaN       sex            NaN   
9                NaN       NaN       NaN   0.309839       sex         2365.0   
10               NaN  0.259016  0.024443        NaN       sex            NaN   
11               NaN       NaN       NaN   0.120065       sex          441.0   

    GFPR     GTP      TP  GTPR  GFNR       FNR  GFP privileged  theil_index  \
0    NaN     NaN     NaN   NaN   NaN       NaN  NaN       None          NaN   
1    NaN     NaN     NaN   NaN   NaN       NaN  NaN       True          NaN   
2    NaN     NaN     NaN   NaN   NaN       NaN  NaN      False          NaN   
3    NaN     NaN     NaN   NaN   NaN       NaN  NaN       None          NaN   
4    NaN     NaN     NaN   NaN   NaN       NaN  NaN       True          NaN   
5    NaN     NaN     NaN   NaN   NaN       NaN  NaN      False          NaN   
6    0.0  2806.0  1713.0   1.0   0.0  0.389522  0.0       None     0.122473   
7    NaN     NaN     NaN   NaN   NaN       NaN  NaN       None          NaN   
8    0.0  2365.0  1487.0   1.0   0.0  0.371247  0.0       True          NaN   
9    NaN     NaN     NaN   NaN   NaN       NaN  NaN       True          NaN   
10   0.0   441.0   226.0   1.0   0.0  0.487528  0.0      False          NaN   
11   NaN     NaN     NaN   NaN   NaN       NaN  NaN      False          NaN   

       FP     GTN      FN       TPR  GFN       PPV               model  \
0     NaN     NaN     NaN       NaN  NaN       NaN                None   
1     NaN     NaN     NaN       NaN  NaN       NaN                None   
2     NaN     NaN     NaN       NaN  NaN       NaN                None   
3     NaN     NaN     NaN       NaN  NaN       NaN                None   
4     NaN     NaN     NaN       NaN  NaN       NaN                None   
5     NaN     NaN     NaN       NaN  NaN       NaN                None   
6   634.0  8500.0  1093.0  0.610478  0.0  0.729868  logisticregression   
7     NaN     NaN     NaN       NaN  NaN       NaN                None   
8   555.0  5268.0   878.0  0.628753  0.0  0.728208  logisticregression   
9     NaN     NaN     NaN       NaN  NaN       NaN                None   
10   79.0  3232.0   215.0  0.512472  0.0  0.740984  logisticregression   
11    NaN     NaN     NaN       NaN  NaN       NaN                None   

         FOR  accuracy      TN subset  GTNR  
0        NaN       NaN     NaN   full   NaN  
1        NaN       NaN     NaN   full   NaN  
2        NaN       NaN     NaN   full   NaN  
3        NaN       NaN     NaN  train   NaN  
4        NaN       NaN     NaN  train   NaN  
5        NaN       NaN     NaN  train   NaN  
6   0.122000  0.847249  7866.0   test   1.0  
7        NaN       NaN     NaN   test   NaN  
8   0.157038  0.812263  4713.0   test   1.0  
9        NaN       NaN     NaN   test   NaN  
10  0.063836  0.919956  3153.0   test   1.0  
11       NaN       NaN     NaN   test   NaN  
</pre>

<div class="org-src-container">
<pre class="src src-python">adult.shape
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">12</td>
<td class="org-right">32</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-python">adult.dtypes
</pre>
</div>

<pre class="example" id="org2e7cce2">
NPV                              float64
TNR                              float64
dataset                           object
num_negatives                    float64
statistical_parity_difference    float64
disparate_impact                 float64
FDR                              float64
FPR                              float64
base_rate                        float64
protected                         object
num_positives                    float64
GFPR                             float64
GTP                              float64
TP                               float64
GTPR                             float64
GFNR                             float64
FNR                              float64
GFP                              float64
privileged                        object
theil_index                      float64
FP                               float64
GTN                              float64
FN                               float64
TPR                              float64
GFN                              float64
PPV                              float64
model                             object
FOR                              float64
accuracy                         float64
TN                               float64
subset                            object
GTNR                             float64
dtype: object
</pre>

<div class="org-src-container">
<pre class="src src-python">adult.describe(include='all')
</pre>
</div>

<pre class="example" id="orgd9a958d">
             NPV       TNR dataset  num_negatives  \
count   3.000000  3.000000      12       9.000000   
unique       NaN       NaN       1            NaN   
top          NaN       NaN   adult            NaN   
freq         NaN       NaN      12            NaN   
mean    0.885709  0.931872     NaN   15117.333333   
std     0.047077  0.040840     NaN   10091.913793   
min     0.842962  0.894647     NaN    3232.000000   
25%     0.860481  0.910029     NaN    8500.000000   
50%     0.878000  0.925412     NaN   13026.000000   
75%     0.907082  0.950484     NaN   20988.000000   
max     0.936164  0.975557     NaN   34014.000000   

        statistical_parity_difference  disparate_impact       FDR       FPR  \
count                        4.000000          4.000000  3.000000  3.000000   
unique                            NaN               NaN       NaN       NaN   
top                               NaN               NaN       NaN       NaN   
freq                              NaN               NaN       NaN       NaN   
mean                        -0.193776          0.354231  0.266980  0.068128   
std                          0.008069          0.032228  0.006947  0.040840   
min                         -0.201944          0.310398  0.259016  0.024443   
25%                         -0.199662          0.344260  0.264574  0.049516   
50%                         -0.194337          0.359509  0.270132  0.074588   
75%                         -0.188451          0.369479  0.270962  0.089971   
max                         -0.184484          0.387509  0.271792  0.105353   

        base_rate protected  num_positives  GFPR          GTP          TP  \
count    9.000000        12       9.000000   3.0     3.000000     3.00000   
unique        NaN         1            NaN   NaN          NaN         NaN   
top           NaN       sex            NaN   NaN          NaN         NaN   
freq          NaN        12            NaN   NaN          NaN         NaN   
mean     0.224943       NaN    4981.333333   0.0  1870.666667  1142.00000   
std      0.087007       NaN    4082.024865   0.0  1257.608975   801.28709   
min      0.111414       NaN     441.000000   0.0   441.000000   226.00000   
25%      0.120065       NaN    1669.000000   0.0  1403.000000   856.50000   
50%      0.247844       NaN    2806.000000   0.0  2365.000000  1487.00000   
75%      0.309839       NaN    8402.000000   0.0  2585.500000  1600.00000   
max      0.313357       NaN   11208.000000   0.0  2806.000000  1713.00000   

        GTPR  GFNR       FNR  GFP privileged  theil_index          FP  \
count    3.0   3.0  3.000000  3.0         12     1.000000    3.000000   
unique   NaN   NaN       NaN  NaN          3          NaN         NaN   
top      NaN   NaN       NaN  NaN       None          NaN         NaN   
freq     NaN   NaN       NaN  NaN          4          NaN         NaN   
mean     1.0   0.0  0.416099  0.0        NaN     0.122473  422.666667   
std      0.0   0.0  0.062531  0.0        NaN          NaN  300.233798   
min      1.0   0.0  0.371247  0.0        NaN     0.122473   79.000000   
25%      1.0   0.0  0.380385  0.0        NaN     0.122473  317.000000   
50%      1.0   0.0  0.389522  0.0        NaN     0.122473  555.000000   
75%      1.0   0.0  0.438525  0.0        NaN     0.122473  594.500000   
max      1.0   0.0  0.487528  0.0        NaN     0.122473  634.000000   

                GTN           FN       TPR  GFN       PPV model       FOR  \
count      3.000000     3.000000  3.000000  3.0  3.000000    12  3.000000   
unique          NaN          NaN       NaN  NaN       NaN     2       NaN   
top             NaN          NaN       NaN  NaN       NaN  None       NaN   
freq            NaN          NaN       NaN  NaN       NaN     9       NaN   
mean    5666.666667   728.666667  0.583901  0.0  0.733020   NaN  0.114291   
std     2656.531071   457.653071  0.062531  0.0  0.006947   NaN  0.047077   
min     3232.000000   215.000000  0.512472  0.0  0.728208   NaN  0.063836   
25%     4250.000000   546.500000  0.561475  0.0  0.729038   NaN  0.092918   
50%     5268.000000   878.000000  0.610478  0.0  0.729868   NaN  0.122000   
75%     6884.000000   985.500000  0.619615  0.0  0.735426   NaN  0.139519   
max     8500.000000  1093.000000  0.628753  0.0  0.740984   NaN  0.157038   

        accuracy           TN subset  GTNR  
count   3.000000     3.000000     12   3.0  
unique       NaN          NaN      3   NaN  
top          NaN          NaN   test   NaN  
freq         NaN          NaN      6   NaN  
mean    0.859823  5244.000000    NaN   1.0  
std     0.054937  2400.950437    NaN   0.0  
min     0.812263  3153.000000    NaN   1.0  
25%     0.829756  3933.000000    NaN   1.0  
50%     0.847249  4713.000000    NaN   1.0  
75%     0.883603  6289.500000    NaN   1.0  
max     0.919956  7866.000000    NaN   1.0  
</pre>

<p>
Each metric is calculated for 3 different subsets of the dataset
(<code>train</code>, <code>test</code> &amp; <code>full</code>). Each metric may further be conditioned in
3 different manner as indicated by value in the <code>privileged</code> column.
<code>None</code> means the metric is calculated on the full dataset, <code>True</code>
means it is conditioned on the privileged group (ie. <code>sex</code> is 1 or
'Male' in our case) and <code>False</code> means it is conditioned on the
unprivileged group (<code>sex</code> is 0 or 'Female').
</p>
</div>
</div>

<div id="outline-container-orgc2454db" class="outline-2">
<h2 id="orgc2454db"><span class="section-number-2">3.</span> Analysis of metrics</h2>
<div class="outline-text-2" id="text-3">
<p>
In this section we analyse the fairness metrics. The section is
further divided into logical subsections.
</p>
</div>

<div id="outline-container-orgf828e2c" class="outline-3">
<h3 id="orgf828e2c"><span class="section-number-3">3.1.</span> Analysis of <code>num_{positive,negative}</code>, <code>num_{true,false}_{positive,negative}</code> &amp; <code>num_{true,false}_{positive_negative}_rate</code></h3>
<div class="outline-text-3" id="text-3-1">
<p>
We start with the <code>num_positives</code>, <code>num_negatives</code> which are computed
only using the dataset.
</p>

<div class="org-src-container">
<pre class="src src-python">name = 'adult_barplot_prot-sex_subset-all_num-pos-neg'

fig, axs = plt.subplots(1, 2, sharey=True, figsize=(10, 5))

sns.barplot(data=adult,
	    y='num_positives',
	    x='subset',
	    hue='privileged',
	    hue_order=['None', 'True', 'False'],
	    ax=axs[0])

sns.barplot(data=adult,
	    y='num_negatives',
	    x='subset',
	    hue='privileged',
	    hue_order=['None', 'True', 'False'],
	    ax=axs[1])

# label the bars with the value, taken from
# &lt;https://stackoverflow.com/a/68323374&gt;
for container in axs[0].containers:
    axs[0].bar_label(container)

for container in axs[1].containers:
    axs[1].bar_label(container)

utils.savefig(fig, name)
</pre>
</div>


<div id="orgbae00a9" class="figure">
<p><img src="adult_barplot_prot-sex_subset-all_num-pos-neg.png" alt="adult_barplot_prot-sex_subset-all_num-pos-neg.png" />
</p>
</div>

<p>
We note that the number of examples for the negative class is far more
than the positive class. This imbalance exists across the various
subsets, this makes sense since we take a random sample from the full
dataset to construct the train &amp; test subsets.
</p>

<p>
In both metrics, we have more examples from the privileged group. That
is, we have more examples where the sex is 'Male'.
</p>

<p>
Thus we have two separate biases that we are dealing with: first is
the imbalance in the <code>class</code> column and second is the imbalance in the
<code>sex</code> column.
</p>

<p>
Lets zoom into only the train subset. This is purely for convenience
of comparing the data &amp; model metrics together (since all model
metrics are calculated using only the test set).
</p>

<div class="org-src-container">
<pre class="src src-python">name = 'adult_barplot_prot-sex_subset-test_num-pos-neg'

fig, axs = plt.subplots(1, 2, sharey=True, figsize=(10, 5))

sns.barplot(data=adult[adult['subset'] == 'test'],
	    y='num_positives',
	    x='subset',
	    hue='privileged',
	    hue_order=['None', 'True', 'False'],
	    ax=axs[0])

sns.barplot(data=adult[adult['subset'] == 'test'],
	    y='num_negatives',
	    x='subset',
	    hue='privileged',
	    hue_order=['None', 'True', 'False'],
	    ax=axs[1])

# label the bars with the value, taken from
# &lt;https://stackoverflow.com/a/68323374&gt;
for container in axs[0].containers:
    axs[0].bar_label(container)

for container in axs[1].containers:
    axs[1].bar_label(container)

utils.savefig(fig, name)
</pre>
</div>


<div id="orgb83a036" class="figure">
<p><img src="adult_barplot_prot-sex_subset-test_num-pos-neg.png" alt="adult_barplot_prot-sex_subset-test_num-pos-neg.png" />
</p>
</div>

<p>
Lets look at the confusion matrices for the linear regression model
next to understand the biases in the model. The confusion matrices
come in two flavours: the absolute &amp; normalised versions.
</p>

<div class="org-src-container">
<pre class="src src-python">name = 'adult_heatmap_prot-sex_cm'
metrics = adult[adult['model'] == 'logisticregression']
cols = ['TN', 'FP', 'FN', 'TP']
fig, axs = plt.subplots(1, 3, figsize=(15, 5))

for idx, privileged in enumerate(['None', 'True', 'False']):
    cm = metrics[metrics['privileged'] == privileged]
    cm = cm[cols].values.reshape(2,2)
    sns.heatmap(data=cm,
		annot=cm,
		fmt="",
		cbar=False,
		cmap='Blues',
		ax=axs[idx])
    axs[idx].set_xlabel("y_pred")
    axs[idx].set_ylabel("y_true")
    axs[idx].set_title(privileged)

utils.savefig(fig, name)
</pre>
</div>


<div id="orgc7fd35a" class="figure">
<p><img src="adult_heatmap_prot-sex_cm.png" alt="adult_heatmap_prot-sex_cm.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-python">name = 'adult_heatmap_prot-sex_cm-rate'
metrics = adult[adult['model'] == 'logisticregression']
cols = ['TNR', 'FPR', 'FNR', 'TPR']
fig, axs = plt.subplots(1, 3, figsize=(15, 5))

for idx, privileged in enumerate(['None', 'True', 'False']):
    cm = metrics[metrics['privileged'] == privileged]
    cm = cm[cols].values.reshape(2,2)
    sns.heatmap(data=cm,
		annot=cm,
		fmt=".3f",
		cbar=False,
		cmap='Blues',
		ax=axs[idx])
    axs[idx].set_xlabel("y_pred")
    axs[idx].set_ylabel("y_true")
    axs[idx].set_title(privileged)

utils.savefig(fig, name)
</pre>
</div>


<div id="org680e8fd" class="figure">
<p><img src="adult_heatmap_prot-sex_cm-rate.png" alt="adult_heatmap_prot-sex_cm-rate.png" />
</p>
</div>

<p>
The model does well with the negative class (~92% accuracy). It
doesn't do so well with the positive class (~61% accuracy) with a less
then idea false negative rate (~39%). This is expected since we have
more number of negative examples in the dataset.
</p>

<p>
The performance of the model remains some what similar across the
conditions on the protected attribute.
</p>

<p>
There is a slight uptick in the true negative rate when we condition
on the unprivileged group (right more plot). The true positive rate
drops slightly here as well, with a rise in the false positive rate.
So the model is able to classify women with a lower income with high
accuracy. But the performance is 50-50 when it comes to women with a
higher income. And this again is corroborated by the fact that we
trained the model with very few examples of women with a high income.
</p>

<div class="org-src-container">
<pre class="src src-python">name = 'adult_heatmap_prot-sex_cm-gen'
metrics = adult[adult['model'] == 'logisticregression']
cols = ['GTN', 'GFP', 'GFN', 'GTP']
fig, axs = plt.subplots(1, 3, figsize=(15, 5))

for idx, privileged in enumerate(['None', 'True', 'False']):
    cm = metrics[metrics['privileged'] == privileged]
    cm = cm[cols].values.reshape(2,2)
    sns.heatmap(data=cm,
		annot=cm,
		fmt="",
		cbar=False,
		cmap='Blues',
		ax=axs[idx])
    axs[idx].set_xlabel("y_pred")
    axs[idx].set_ylabel("y_true")
    axs[idx].set_title(privileged)

utils.savefig(fig, name)
</pre>
</div>


<div id="org7157fe2" class="figure">
<p><img src="adult_heatmap_prot-sex_cm-gen.png" alt="adult_heatmap_prot-sex_cm-gen.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-python">name = 'adult_heatmap_prot-sex_cm-gen-rate'
metrics = adult[adult['model'] == 'logisticregression']
cols = ['GTNR', 'GFPR', 'GFNR', 'GTPR']
fig, axs = plt.subplots(1, 3, figsize=(15, 5))

for idx, privileged in enumerate(['None', 'True', 'False']):
    cm = metrics[metrics['privileged'] == privileged]
    cm = cm[cols].values.reshape(2,2)
    sns.heatmap(data=cm,
		annot=cm,
		fmt=".3f",
		cbar=False,
		cmap='Blues',
		ax=axs[idx])
    axs[idx].set_xlabel("y_pred")
    axs[idx].set_ylabel("y_true")
    axs[idx].set_title(privileged)

utils.savefig(fig, name)
</pre>
</div>


<div id="orgcfccba4" class="figure">
<p><img src="adult_heatmap_prot-sex_cm-gen-rate.png" alt="adult_heatmap_prot-sex_cm-gen-rate.png" />
</p>
</div>

<p>
The <code>num_generalized_*</code> metrics use the probability associated with
the predicted label (rather than the absolute label). I assume there
is some sort of rounding up going on internally which results in the
true negative &amp; true positive numbers to be exactly the same as the
data. It will be interesting to experiment here more &amp; see when (and
if) these numbers change for variation in the dataset or model.
</p>
</div>
</div>

<div id="outline-container-orgd00b2fb" class="outline-3">
<h3 id="orgd00b2fb"><span class="section-number-3">3.2.</span> Analysis of <code>base_rate</code></h3>
<div class="outline-text-3" id="text-3-2">
<p>
The <code>base_rate</code> is the probability that the label of a given example
is positive.
</p>

<div class="org-src-container">
<pre class="src src-python">name = 'adult_barplot_prot-sex_base-rate'

fig, ax = plt.subplots()

sns.barplot(data=adult,
	    y='base_rate',
	    x='subset',
	    hue='privileged',
	    hue_order=['None', 'True', 'False'],
	    ax=ax)

for container in ax.containers:
    ax.bar_label(container)

utils.savefig(fig, name)

</pre>
</div>


<div id="org5e42692" class="figure">
<p><img src="adult_barplot_prot-sex_base-rate.png" alt="adult_barplot_prot-sex_base-rate.png" />
</p>
</div>

<p>
Here, we note that the <code>base_rate</code> is similar across the subsets and
the conditions. This makes sense since we used random sampling to
generate the train &amp; test subsets.
</p>

<p>
The unconditioned <code>base_rate</code> is ~25% and this makes sense since we
have more examples of the negative class. The conditioned <code>base_rate</code>
for the privileged group is higher than the unprivileged group (~30%
vs. ~11%). This makes sense as well since we have more examples of the
privileged group.
</p>
</div>
</div>

<div id="outline-container-org3e436e6" class="outline-3">
<h3 id="org3e436e6"><span class="section-number-3">3.3.</span> Analysis of <code>{positive,negative}_predictive_value</code> &amp; <code>false_{discovery,omission}_rate</code></h3>
<div class="outline-text-3" id="text-3-3">
<p>
The wikipedia page on <a href="https://en.wikipedia.org/wiki/Binary_classification">binary classification</a> was very helpful to make
sense of these metrics. Following is a table summarising their
mathematical formulas
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">PPV</td>
<td class="org-left">TP/(TP+FP)</td>
</tr>

<tr>
<td class="org-left">FDR</td>
<td class="org-left">FP/(TP+FP)</td>
</tr>

<tr>
<td class="org-left">FOR</td>
<td class="org-left">FN/(TN+FN)</td>
</tr>

<tr>
<td class="org-left">NPV</td>
<td class="org-left">TN/(TN+FN)</td>
</tr>
</tbody>
</table>

<p>
With the following model of confusion matrix (where <code>y_true</code> is on y
axis and <code>y_pred</code> is on x axis):
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">y<sub>true</sub></td>
<td class="org-right">0</td>
<td class="org-left">TN</td>
<td class="org-left">FP</td>
</tr>

<tr>
<td class="org-left">y<sub>true</sub></td>
<td class="org-right">1</td>
<td class="org-left">FN</td>
<td class="org-left">TP</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-left">0</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-left">y<sub>pred</sub></td>
<td class="org-left">y<sub>pred</sub></td>
</tr>
</tbody>
</table>

<p>
We visualise the above metrics in a confusion matrix like so:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">y<sub>true</sub></td>
<td class="org-right">0</td>
<td class="org-left">NPV</td>
<td class="org-left">FDR</td>
</tr>

<tr>
<td class="org-left">y<sub>true</sub></td>
<td class="org-right">1</td>
<td class="org-left">FOR</td>
<td class="org-left">PPV</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-left">0</td>
<td class="org-left">1</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-right">&#xa0;</td>
<td class="org-left">y<sub>pred</sub></td>
<td class="org-left">y<sub>pred</sub></td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-python">name = 'adult_heatmap_prot-sex_cm-ppv-fdr-for-npv'
metrics = adult[adult['model'] == 'logisticregression']
cols = ['NPV', 'FDR', 'FOR', 'PPV']
fig, axs = plt.subplots(1, 3, figsize=(15, 5))

for idx, privileged in enumerate(['None', 'True', 'False']):
    cm = metrics[metrics['privileged'] == privileged]
    cm = cm[cols].values.reshape(2,2)
    sns.heatmap(data=cm,
		annot=cm,
		fmt=".3f",
		cbar=False,
		cmap='Blues',
		ax=axs[idx])
    axs[idx].set_xlabel("y_pred")
    axs[idx].set_ylabel("y_true")
    axs[idx].set_title(privileged)

utils.savefig(fig, name)
</pre>
</div>


<div id="org4d736b4" class="figure">
<p><img src="adult_heatmap_prot-sex_cm-ppv-fdr-for-npv.png" alt="adult_heatmap_prot-sex_cm-ppv-fdr-for-npv.png" />
</p>
</div>

<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> I still don't understand what the metrics imply?</li>
<li class="off"><code>[&#xa0;]</code> PPV is also the precision, review precision &amp; recall</li>
</ul>
</div>
</div>

<div id="outline-container-orgc528df6" class="outline-3">
<h3 id="orgc528df6"><span class="section-number-3">3.4.</span> Analysis of <code>disparate_impact</code> &amp; <code>statistical_parity_difference</code></h3>
<div class="outline-text-3" id="text-3-4">
<p>
These metrics exist both for the data &amp; the model so we should compare
them and see how they differ. For each metric, we create two plots:
First, we observe the distribution of the metric across the subsets.
And second we compare the distribution of the metric when calculated
with &amp; without a model.
</p>

<div class="org-src-container">
<pre class="src src-python">name = 'adult_barplot_prot-sex_subset-all_disparate-impact'

fig, ax = plt.subplots()

sns.barplot(data=adult[adult['model'] == 'None'],
	    y='disparate_impact',
	    x='subset',
	    ax=ax)

for container in ax.containers:
    ax.bar_label(container)

utils.savefig(fig, name)
</pre>
</div>


<div id="org89eb9b9" class="figure">
<p><img src="adult_barplot_prot-sex_subset-all_disparate-impact.png" alt="adult_barplot_prot-sex_subset-all_disparate-impact.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-python">name = 'adult_barplot_prot-sex_subset-test_disparate-impact'

fig, ax = plt.subplots()

sns.barplot(data=adult[adult['subset'] == 'test'],
	    y='disparate_impact',
	    x='model',
	    ax=ax)

for container in ax.containers:
    ax.bar_label(container)

utils.savefig(fig, name)
</pre>
</div>


<div id="orgafbeba6" class="figure">
<p><img src="adult_barplot_prot-sex_subset-test_disparate-impact.png" alt="adult_barplot_prot-sex_subset-test_disparate-impact.png" />
</p>
</div>

<p>
<code>disparate_impact</code> when calculated without a model, is expressed
mathematically as follows:
</p>

\begin{equation}
\frac{Pr(Y=1) | D = \text{unprivileged}}{Pr(Y=1) | D =
\text{privileged}}
\end{equation}

<div class="org-src-container">
<pre class="src src-python">name = 'adult_barplot_prot-sex_subset-all_stat-par-diff'

fig, ax = plt.subplots()

sns.barplot(data=adult[adult['model'] == 'None'],
	    y='statistical_parity_difference',
	    x='subset',
	    ax=ax)

for container in ax.containers:
    ax.bar_label(container)

utils.savefig(fig, name)
</pre>
</div>


<div id="org80c1107" class="figure">
<p><img src="adult_barplot_prot-sex_subset-all_stat-par-diff.png" alt="adult_barplot_prot-sex_subset-all_stat-par-diff.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-python">name = 'adult_barplot_prot-sex_subset-test_stat-par-diff'

fig, ax = plt.subplots()

sns.barplot(data=adult[adult['subset'] == 'test'],
	    y='statistical_parity_difference',
	    x='model',
	    ax=ax)

for container in ax.containers:
    ax.bar_label(container)

utils.savefig(fig, name)
</pre>
</div>


<div id="org5a28f98" class="figure">
<p><img src="adult_barplot_prot-sex_subset-test_stat-par-diff.png" alt="adult_barplot_prot-sex_subset-test_stat-par-diff.png" />
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-07-25 Mon 00:00</p>
<p class="author">Author: Arumoy Shome</p>
<p class="date">Created: 2022-08-02 Tue 15:17</p>
</div>
</body>
</html>
